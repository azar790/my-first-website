<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hava haqqƒ±nda m…ôlumat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'float': 'float 3s ease-in-out infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
    }
    .weather-card {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark .weather-card {
      background: rgba(0, 0, 0, 0.2);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #6e8efb, #a777e3);
    }
    .dark .gradient-bg {
      background: linear-gradient(135deg, #4b6cb7, #182848);
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-500 gradient-bg min-h-screen">
  <div class="container mx-auto px-4 py-8 flex flex-col items-center justify-center min-h-screen">
    <!-- Header -->
    <header class="w-full flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold text-white">WeatherSphere</h1>
      <button id="toggleTheme" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition-all duration-300 text-white">
        <i id="themeIcon" class="fas fa-moon text-lg"></i>
      </button>
    </header>

    <!-- Main Card -->
    <div id="weatherCard" class="weather-card rounded-2xl p-6 w-full max-w-md shadow-2xl overflow-hidden relative animate-fade-in transition-all duration-500">
      <!-- Loading State -->
      <div id="loading" class="flex flex-col items-center justify-center py-12">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-white">Detecting your weather...</p>
      </div>

      <!-- Weather Content -->
      <div id="weatherContent" class="hidden">
        <!-- Location & Date -->
        <div class="flex justify-between items-start mb-6">
          <div>
            <h2 id="location" class="text-xl font-semibold text-white">New York, NY</h2>
            <p id="date" class="text-white/80 text-sm">Monday, June 12</p>
          </div>
          <div id="currentTemp" class="text-4xl font-bold text-white">24¬∞</div>
        </div>

        <!-- Weather Emoji -->
        <div class="flex justify-center my-6">
          <div id="emoji" class="text-8xl animate-float">‚òÄÔ∏è</div>
        </div>

        <!-- Weather Description -->
        <div class="text-center mb-6">
          <p id="desc" class="text-xl font-medium text-white">Sunny</p>
          <p id="feelsLike" class="text-white/80">Feels like 26¬∞</p>
        </div>

        <!-- Weather Details Grid -->
        <div class="grid grid-cols-2 gap-4 mt-6">
          <div class="bg-white/10 rounded-lg p-3 text-center backdrop-blur-sm">
            <i class="fas fa-wind text-white/80 mb-1"></i>
            <p class="text-white text-sm">Wind</p>
            <p id="wind" class="text-white font-medium">12 km/h</p>
          </div>
          <div class="bg-white/10 rounded-lg p-3 text-center backdrop-blur-sm">
            <i class="fas fa-tint text-white/80 mb-1"></i>
            <p class="text-white text-sm">Humidity</p>
            <p id="humidity" class="text-white font-medium">65%</p>
          </div>
          <div class="bg-white/10 rounded-lg p-3 text-center backdrop-blur-sm">
            <i class="fas fa-eye text-white/80 mb-1"></i>
            <p class="text-white text-sm">Visibility</p>
            <p id="visibility" class="text-white font-medium">10 km</p>
          </div>
          <div class="bg-white/10 rounded-lg p-3 text-center backdrop-blur-sm">
            <i class="fas fa-cloud-rain text-white/80 mb-1"></i>
            <p class="text-white text-sm">Pressure</p>
            <p id="pressure" class="text-white font-medium">1012 hPa</p>
          </div>
        </div>

        <!-- Refresh Button -->
        <div class="flex justify-center mt-6">
          <button id="refreshWeather" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-white transition-all flex items-center gap-2">
            <i class="fas fa-sync-alt"></i> Refresh Weather
          </button>
        </div>
      </div>

      <!-- Error State -->
      <div id="errorState" class="hidden text-center py-8">
        <i class="fas fa-exclamation-triangle text-3xl text-yellow-400 mb-3"></i>
        <p id="errorMessage" class="text-white">Could not fetch weather data</p>
        <button id="retryButton" class="mt-4 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-white transition-all">
          Try Again
        </button>
      </div>
    </div>

    <!-- Forecast Section -->
    <div id="forecast" class="weather-card rounded-2xl p-6 w-full max-w-md mt-6 hidden animate-fade-in">
      <h3 class="text-white font-medium mb-4">5-Day Forecast</h3>
      <div class="space-y-3">
        <!-- Forecast items will be added here by JS -->
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center text-white/60 text-sm">
      <p>Powered by Open-Meteo API</p>
      <p class="mt-1">Updated: <span id="updateTime">Just now</span></p>
    </footer>
  </div>

  <script>
    // DOM Elements
    const elements = {
      weatherCard: document.getElementById("weatherCard"),
      loading: document.getElementById("loading"),
      weatherContent: document.getElementById("weatherContent"),
      errorState: document.getElementById("errorState"),
      errorMessage: document.getElementById("errorMessage"),
      retryButton: document.getElementById("retryButton"),
      forecast: document.getElementById("forecast"),
      location: document.getElementById("location"),
      date: document.getElementById("date"),
      emoji: document.getElementById("emoji"),
      desc: document.getElementById("desc"),
      currentTemp: document.getElementById("currentTemp"),
      feelsLike: document.getElementById("feelsLike"),
      wind: document.getElementById("wind"),
      humidity: document.getElementById("humidity"),
      visibility: document.getElementById("visibility"),
      pressure: document.getElementById("pressure"),
      updateTime: document.getElementById("updateTime"),
      toggleBtn: document.getElementById("toggleTheme"),
      themeIcon: document.getElementById("themeIcon"),
      refreshWeather: document.getElementById("refreshWeather")
    };

    // Weather API Configuration - Open-Meteo (no API key required)
    const WEATHER_API_URL = 'https://api.open-meteo.com/v1/forecast';
    const GEO_API_URL = 'https://geocoding-api.open-meteo.com/v1/search';

    // Theme Toggle
    elements.toggleBtn.onclick = () => {
      document.documentElement.classList.toggle("dark");
      const isDark = document.documentElement.classList.contains("dark");
      elements.themeIcon.className = isDark ? "fas fa-sun text-lg" : "fas fa-moon text-lg";
      
      // Update gradient background
      document.body.className = isDark 
        ? "dark:bg-gray-900 text-gray-100 transition-colors duration-500 gradient-bg min-h-screen"
        : "bg-gray-50 text-gray-800 transition-colors duration-500 gradient-bg min-h-screen";
    };

    // Refresh Weather button
    elements.refreshWeather.addEventListener('click', fetchWeather);
    elements.retryButton.addEventListener('click', fetchWeather);

    // Format date
    function formatDate(date) {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString(undefined, options);
    }

    // Format time
    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Get weather emoji based on WMO weather code
    // https://open-meteo.com/en/docs#weathervariables
    function getWeatherEmoji(wmoCode) {
      // Clear
      if (wmoCode === 0) return "‚òÄÔ∏è";
      // Mainly clear, partly cloudy
      if (wmoCode <= 2) return "üå§Ô∏è";
      // Overcast
      if (wmoCode === 3) return "‚òÅÔ∏è";
      // Fog
      if (wmoCode <= 49) return "üå´Ô∏è";
      // Drizzle
      if (wmoCode <= 59) return "üåßÔ∏è";
      // Rain
      if (wmoCode <= 69) return "üåßÔ∏è";
      // Snow
      if (wmoCode <= 79) return "‚ùÑÔ∏è";
      // Rain showers
      if (wmoCode <= 82) return "üå¶Ô∏è";
      // Snow showers
      if (wmoCode <= 86) return "üå®Ô∏è";
      // Thunderstorm
      if (wmoCode <= 99) return "‚õàÔ∏è";
      return "üå°Ô∏è"; // Default
    }

    // Get weather description based on WMO weather code
    function getWeatherDescription(wmoCode) {
      if (wmoCode === 0) return "Clear sky";
      if (wmoCode === 1) return "Mainly clear";
      if (wmoCode === 2) return "Partly cloudy";
      if (wmoCode === 3) return "Overcast";
      if (wmoCode <= 49) return "Fog";
      if (wmoCode <= 59) return "Drizzle";
      if (wmoCode <= 69) return "Rain";
      if (wmoCode <= 79) return "Snow";
      if (wmoCode <= 82) return "Rain showers";
      if (wmoCode <= 86) return "Snow showers";
      if (wmoCode <= 99) return "Thunderstorm";
      return "Unknown";
    }

    // Get user location by IP address
    async function getLocationByIP() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        
        if (data.error) {
          throw new Error("IP geolocation failed");
        }
        
        return {
          latitude: data.latitude,
          longitude: data.longitude,
          city: data.city,
          country: data.country_code
        };
      } catch (error) {
        console.error("IP geolocation error:", error);
        // Default to New York if all else fails
        return {
          latitude: 40.7128,
          longitude: -74.0060,
          city: "New York",
          country: "US"
        };
      }
    }

    // Get user location (tries browser geolocation first, then falls back to IP)
    async function getLocation() {
      return new Promise(async (resolve) => {
        // Try browser geolocation first
        if (navigator.geolocation) {
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error("Geolocation timeout")), 5000);
          });
          
          try {
            const positionPromise = new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject);
            });
            
            // Race between position and timeout
            const position = await Promise.race([positionPromise, timeoutPromise]);
            resolve({
              latitude: position.coords.latitude, 
              longitude: position.coords.longitude
            });
            return;
          } catch (error) {
            console.warn("Browser geolocation failed:", error);
            // Continue to IP geolocation
          }
        }
        
        // Fall back to IP-based geolocation
        const ipLocation = await getLocationByIP();
        resolve(ipLocation);
      });
    }

    // Get city name from coordinates using Open-Meteo Geocoding API
    async function getCityFromCoordinates(lat, lon) {
      try {
        const response = await fetch(`${GEO_API_URL}?latitude=${lat}&longitude=${lon}&count=1`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
          const location = data.results[0];
          return {
            name: location.name,
            country: location.country_code
          };
        }
        throw new Error("Location not found");
      } catch (error) {
        console.error("Reverse geocoding error:", error);
        return null;
      }
    }

    // Fetch weather data from Open-Meteo API
    async function fetchWeatherData(lat, lon) {
      const params = new URLSearchParams({
        latitude: lat,
        longitude: lon,
        current: "temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,cloud_cover,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m",
        daily: "weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum",
        timezone: "auto",
        forecast_days: 7
      });
      
      const response = await fetch(`${WEATHER_API_URL}?${params}`);
      return await response.json();
    }

    // Update UI with weather data
    async function updateWeatherUI(weatherData, locationData) {
      const now = new Date();
      elements.date.textContent = formatDate(now);
      elements.updateTime.textContent = `Today at ${formatTime(now)}`;
      
      // Get city name if we have coordinates but no location name
      let locationName = null;
      if (locationData) {
        if (locationData.city) {
          locationName = `${locationData.city}, ${locationData.country}`;
        } else if (locationData.latitude && locationData.longitude) {
          const cityData = await getCityFromCoordinates(locationData.latitude, locationData.longitude);
          if (cityData) {
            locationName = `${cityData.name}, ${cityData.country}`;
          }
        }
      }
      
      // Set location name
      elements.location.textContent = locationName || "Baku";
      
      // Current weather from Open-Meteo
      const current = weatherData.current;
      
      // Weather icon and description
      const wmoCode = current.weather_code;
      elements.emoji.textContent = getWeatherEmoji(wmoCode);
      elements.desc.textContent = getWeatherDescription(wmoCode);
      
      // Temperature
      elements.currentTemp.textContent = `${Math.round(current.temperature_2m)}¬∞`;
      elements.feelsLike.textContent = `Feels like ${Math.round(current.apparent_temperature)}¬∞`;
      
      // Wind
      elements.wind.textContent = `${Math.round(current.wind_speed_10m)} km/h`;
      
      // Humidity
      elements.humidity.textContent = `${current.relative_humidity_2m}%`;
      
      // Visibility (using cloud cover as proxy since Open-Meteo doesn't provide visibility)
      const visibility = 100 - current.cloud_cover;
      elements.visibility.textContent = `${visibility}%`;
      
      // Pressure
      const pressure = current.surface_pressure || current.pressure_msl || "N/A";
      elements.pressure.textContent = typeof pressure === "number" ? `${Math.round(pressure)} hPa` : pressure;
    }

    // Update forecast UI
    function updateForecastUI(weatherData) {
      const forecastContainer = elements.forecast.querySelector('div');
      forecastContainer.innerHTML = '';
      
      // Check if forecast data is valid
      if (!weatherData || !weatherData.daily || !weatherData.daily.time) {
        elements.forecast.classList.add('hidden');
        return;
      }
      
      // Get daily forecast data
      const { time, weather_code, temperature_2m_max, temperature_2m_min } = weatherData.daily;
      
      // Create daily forecast items (skipping today)
      for (let i = 1; i < time.length && i <= 5; i++) {
        const date = new Date(time[i]);
        const day = date.toLocaleDateString(undefined, { weekday: 'short' });
        const wmoCode = weather_code[i];
        const maxTemp = Math.round(temperature_2m_max[i]);
        const minTemp = Math.round(temperature_2m_min[i]);
        
        const forecastItem = document.createElement('div');
        forecastItem.className = 'flex items-center justify-between py-2 border-b border-white/10 last:border-0';
        forecastItem.innerHTML = `
          <div class="flex items-center">
            <span class="text-white w-16">${day}</span>
            <span class="text-2xl mr-3">${getWeatherEmoji(wmoCode)}</span>
            <span class="text-white">${getWeatherDescription(wmoCode)}</span>
          </div>
          <div class="text-white">
            <span class="font-medium">${maxTemp}¬∞</span>
            <span class="text-white/60">/${minTemp}¬∞</span>
          </div>
        `;
        forecastContainer.appendChild(forecastItem);
      }
      
      elements.forecast.classList.remove('hidden');
    }

    // Show error message
    function showError(message) {
      elements.loading.classList.add('hidden');
      elements.weatherContent.classList.add('hidden');
      elements.errorState.classList.remove('hidden');
      elements.errorMessage.textContent = message || "Could not fetch weather data";
    }

    // Fetch weather
    async function fetchWeather() {
      try {
        // Show loading state
        elements.loading.classList.remove('hidden');
        elements.weatherContent.classList.add('hidden');
        elements.errorState.classList.add('hidden');
        elements.forecast.classList.add('hidden');
        
        // Get user location (with fallback to IP)
        const locationData = await getLocation();
        
        // Fetch weather data from Open-Meteo
        const weatherData = await fetchWeatherData(
          locationData.latitude, 
          locationData.longitude
        );
        
        // Update UI
        await updateWeatherUI(weatherData, locationData);
        updateForecastUI(weatherData);
        
        // Show content
        elements.loading.classList.add('hidden');
        elements.weatherContent.classList.remove('hidden');
        
      } catch (err) {
        console.error("Error fetching weather data:", err);
        showError(err.message);
      }
    }

    // Initialize
    fetchWeather();
  </script>
</body>
</html>
